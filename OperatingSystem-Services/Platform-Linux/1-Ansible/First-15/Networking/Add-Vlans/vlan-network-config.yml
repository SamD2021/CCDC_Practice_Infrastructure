---
- name: Configure network for VLAN on all machines
  hosts: vlan-machines
  become: yes
  tasks:
    - name: Backup existing netplan config
      copy:
        src: /etc/netplan/50-cloud-init.yaml
        dest: /etc/netplan/50-cloud-init.yaml.bak
        remote_src: yes

    - name: Configure netplan for VLAN network
      template:
        src: netplan_template.j2
        dest: /etc/netplan/50-cloud-init.yaml

    - name: Try netplan configuration
      command: netplan try
